<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Mountains+of+Christmas:wght@700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    
    <title><%= locals.titulo %></title>
</head>
<body class="bg-light">

    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/admin">
                <%= locals.lojaNome %> <span class="badge bg-secondary fs-6 align-middle">Admin</span>
            </a>
            <div>
                <a class="btn btn-outline-light me-2" href="/">Ver Loja</a>
                <a class="btn btn-outline-warning" href="/logout">Sair</a>
            </div>
        </div>
    </nav>

    <main class="container my-4">

        <% if (typeof error !== 'undefined' && error) { %>
            <div class="alert alert-danger" role="alert">
                Erro ao carregar dados do painel: <%= error %>
            </div>
        <% } %>
        <% if (typeof locals.currentUrl !== 'undefined' && locals.currentUrl.includes('statusError=1')) { %>
            <div class="alert alert-danger" role="alert">
                Erro ao atualizar status: Dados inválidos recebidos.
            </div>
        <% } %>
        <% if (typeof locals.currentUrl !== 'undefined' && locals.currentUrl.includes('statusError=2')) { %>
             <div class="alert alert-warning" role="alert">
                 Erro ao atualizar status: Pedido não encontrado.
             </div>
         <% } %>
         <% if (typeof locals.currentUrl !== 'undefined' && locals.currentUrl.includes('error=camposObrigatorios')) { %>
             <div class="alert alert-warning" role="alert">
                 Falha ao adicionar produto: Nome, Preço e Descrição são obrigatórios.
             </div>
         <% } %>
         <% if (typeof locals.currentUrl !== 'undefined' && locals.currentUrl.includes('error=dbError')) { %>
             <div class="alert alert-danger" role="alert">
                 Erro de Banco de Dados. Verifique o console do servidor.
             </div>
         <% } %>

        <section class="mb-4">
            <div class="card shadow-sm">
                <div class="card-header"><h2 class="h5 mb-0">Adicionar Novo Produto</h2></div>
                <div class="card-body">
                    <form action="/admin/adicionar-produto" method="POST">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="nome" class="form-label">Nome:</label>
                                <input type="text" class="form-control" id="nome" name="nome" required>
                            </div>
                            <div class="col-md-3">
                                <label for="preco" class="form-label">Preço Normal (R$):</label>
                                <input type="number" step="0.01" class="form-control" id="preco" name="preco" required>
                            </div>
                            <div class="col-md-3">
                                <label for="preco_promocional" class="form-label">Preço Promocional (Opcional):</label>
                                <input type="number" step="0.01" class="form-control" id="preco_promocional" name="preco_promocional" placeholder="Ex: 79.90">
                            </div>
                            <div class="col-12">
                                <label for="descricao" class="form-label">Descrição:</label>
                                <textarea class="form-control" id="descricao" name="descricao" rows="3" required></textarea>
                            </div>
                            <div class="col-12">
                                <label for="imagem" class="form-label">URLs das Imagens (separadas por vírgula):</label>
                                <textarea class="form-control" id="imagem" name="imagem" rows="3" placeholder="/img/img1.jpg,/img/img2.jpg,..."></textarea>
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">Adicionar</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <section class="mb-5">
            <h2 class="h4 mb-3">Gerenciar Produtos</h2>
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0 align-middle">
                            <thead class="table-dark"><tr><th>ID</th><th>Produto</th><th>Preço</th><th class="text-end">Ações</th></tr></thead>
                            <tbody>
                                <% if (typeof produtos !== 'undefined' && produtos.length > 0) { %>
                                    <% produtos.forEach(produto => { %>
                                        <tr>
                                            <td><%= produto.id %></td>
                                            <td><%= produto.nome %></td>
                                            <td>
                                                <% if (produto.preco_promocional && produto.preco_promocional > 0) { %>
                                                    <del class="text-muted">R$ <%= produto.preco.toFixed(2) %></del>
                                                    <strong class="text-success">R$ <%= produto.preco_promocional.toFixed(2) %></strong>
                                                <% } else { %>
                                                    R$ <%= produto.preco.toFixed(2) %>
                                                <% } %>
                                            </td>
                                            <td class="text-end">
                                                <a href="/admin/editar/<%= produto.id %>" class="btn btn-warning btn-sm"><i class="bi bi-pencil-square"></i> Editar</a>
                                                <form action="/admin/excluir" method="POST" class="d-inline-block ms-1">
                                                    <input type="hidden" name="id" value="<%= produto.id %>">
                                                    <button type="submit" class="btn btn-danger btn-sm"><i class="bi bi-trash"></i> Excluir</button>
                                                </form>
                                            </td>
                                        </tr>
                                    <% }); %>
                                <% } %>
                                <% if (typeof produtos === 'undefined' || produtos.length === 0) { %>
                                    <tr><td colspan="4" class="text-center p-4">Nenhum produto cadastrado.</td></tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section>
            <h2 class="h4 mb-3">Gerenciar Pedidos</h2>
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0 align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th>#</th><th>Data</th><th>Cliente</th><th>Total</th><th>Status Atual</th><th style="min-width: 200px;">Mudar Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% if (typeof pedidos !== 'undefined' && pedidos.length > 0) { %>
                                    <% pedidos.forEach(pedido => { %>
                                        <tr>
                                            <td><%= pedido.id %></td>
                                            <td><small><%= pedido.data_formatada || 'N/A' %></small></td>
                                            <td>
                                                <%= pedido.cliente_nome || 'N/A' %><br>
                                                <small class="text-muted"><%= pedido.cliente_email || 'N/A' %></small>
                                            </td>
                                            <td>R$ <%= pedido.valor_total ? pedido.valor_total.toFixed(2) : '0.00' %></td>
                                            <td>
                                                <%# LÓGICA DO BADGE CORRIGIDA (SEM ELSE IF) %>
                                                <% let badgeClass = 'bg-secondary'; %>
                                                <% if (pedido.status === 'Enviado') { badgeClass = 'bg-info text-dark'; } %>
                                                <% if (pedido.status === 'Entregue') { badgeClass = 'bg-success'; } %>
                                                <% if (pedido.status === 'Cancelado') { badgeClass = 'bg-danger'; } %>
                                                <% if (pedido.status === 'Processando') { badgeClass = 'bg-warning text-dark'; } %>
                                                <span class="badge <%= badgeClass %>"><%= pedido.status || 'Indefinido' %></span>
                                            </td>
                                            <td>
                                                <form action="/admin/update-status" method="POST" class="d-flex align-items-center">
                                                    <input type="hidden" name="pedidoId" value="<%= pedido.id %>">
                                                    <select name="novoStatus" class="form-select form-select-sm me-2">
                                                        <option value="Processando" <%= pedido.status === 'Processando' ? 'selected' : '' %>>Processando</option>
                                                        <option value="Enviado"     <%= pedido.status === 'Enviado' ? 'selected' : '' %>>Enviado</option>
                                                        <option value="Entregue"    <%= pedido.status === 'Entregue' ? 'selected' : '' %>>Entregue</option>
                                                        <option value="Cancelado"   <%= pedido.status === 'Cancelado' ? 'selected' : '' %>>Cancelado</option>
                                                    </select>
                                                    <button type="submit" class="btn btn-primary btn-sm">
                                                        <i class="bi bi-check-lg"></i>
                                                    </button>
                                                </form>
                                            </td>
                                        </tr>
                                    <% }); %>
                                <% } %>
                                <% if (typeof pedidos === 'undefined' || pedidos.length === 0) { %>
                                    <tr>
                                        <td colspan="6" class="text-center p-4 text-muted">Nenhum pedido encontrado.</td>
                                    </tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>